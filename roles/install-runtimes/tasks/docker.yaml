---
- name: Install packages to allow apt to use a repository over HTTPS
  apt:
    name: ['apt-transport-https', 'ca-certificates', 'curl', 'software-properties-common']
    state: latest
    update_cache: yes

- name: Add Dockerâ€™s official GPG key
  apt_key:
    url: https://download.docker.com/linux/ubuntu/gpg
    state: present

- name: Add Docker apt repository
  apt_repository:
    repo: deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_lsb.codename }} stable
    state: present
    update_cache: yes

- name: Install docker
  apt:
    name: docker-ce=18.06.2~ce~3-0~ubuntu
    state: present
    update_cache: yes

- name: Create /etc/cni/net.d/ directory
  file:
    path: /etc/cni/net.d
    state: directory
    recurse: yes

- name: Puch /etc/cni/net.d/99-loopback.conf
  copy:
    src: 99-loopback.conf
    dest: /etc/cni/net.d/99-loopback.conf
  notify:
    - restart docker

- name: Create /opt/cni/bin/ directory
  file:
    path: /opt/cni/bin/
    state: directory

- name: Download CNI 0.8.1
  unarchive:
    src: https://github.com/containernetworking/plugins/releases/download/v0.8.1/cni-plugins-linux-amd64-v0.8.1.tgz
    dest: /opt/cni/bin/
    remote_src: yes
    creates: /opt/cni/bin/bridge
  notify:
    - restart docker

- name: Configure /etc/docker/daemon.json
  copy:
    dest: /etc/docker/daemon.json
    src: daemon.json
  notify:
    - Reload docker

- name: Create /etc/systemd/system/docker.service.d directory
  file:
    path: /etc/systemd/system/docker.service.d
    state: directory
    recurse: yes

- name: Make sure docker is running
  systemd:
    state: started
    name: docker
    enabled: yes
